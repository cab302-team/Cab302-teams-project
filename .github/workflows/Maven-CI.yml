name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: maven

      #  Ensures that the JAR mockito-core-${mockito.version}.jar exists in ${settings.localRepository} (usually ~/.m2/repository) when the surefire plugin starts.
      - name: Resolve Maven dependencies
        run: mvn dependency:resolve

#      - name: Build and run tests
#        run: mvn clean verify

#      - name: Report
#        if: always()
#        uses: dorny/test-reporter@v1
#        with:
#          name: Maven Tests
#          path: "target/surefire-reports/*.xml"
#          reporter: java-junit
#          fail-on-error: true
#
#      - name: Generate Javadoc
#        run: mvn javadoc:javadoc
#      - name: Publish Javadoc
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          folder: target/docs/javadoc
#          clean: true
#          target-folder: javadoc
#
#      - name: Publish Coverage Report
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          folder: target/site/jacoco
#          clean: false
#          target-folder: coverage
#
#      # Convert the HTML reports into PDFs
#      - name: Install wkhtmltopdf and pdfunite
#        run: |
#          sudo apt-get update
#          sudo apt-get install -y wkhtmltopdf
#          sudo apt-get install -y poppler-utils
#
#      - name: Create output directories
#        run: |
#          mkdir -p individual-pdfs
#          mkdir -p pdfs
#
#      - name: Generate PDFs from all JaCoCo HTML files
#        run: |
#          i=0
#          for file in $(find target/site/jacoco -name '*.html' | sort); do
#            wkhtmltopdf --enable-local-file-access "$file" individual-pdfs/jacoco-$i.pdf
#            i=$((i+1))
#          done
#
#      - name: Merge JaCoCo PDFs into one
#        run: |
#          pdfunite individual-pdfs/jacoco-*.pdf pdfs/test-coverage.pdf
#
#      - name: Generate PDFs from all Javadoc HTML files
#        run: |
#          i=0
#          for file in $(find target/docs/javadoc -name '*.html' | sort); do
#            wkhtmltopdf --enable-local-file-access "$file" individual-pdfs/javadoc-$i.pdf
#            i=$((i+1))
#          done
#
#      - name: Merge Javadoc PDFs into one
#        run: |
#          pdfunite individual-pdfs/javadoc-*.pdf pdfs/javadoc.pdf
#
#      - name: Commit PDFs to documentation branch
#        run: |
#          git config user.name "github-actions[bot]"
#          git config user.email "github-actions[bot]@users.noreply.github.com"
#          git checkout -B documentation
#          git add pdfs/*.pdf
#          git commit -m "Update documentation and test coverage PDFs [skip ci]"
#          git push --force origin documentation
#
#      - name: Publish PDFs to GitHub Pages
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          folder: pdfs
#          clean: false
#          target-folder: pdfs

      - name: Package application JAR
        run: mvn clean package -DskipTests

      - name: Download Launch4j CLI 3.16+
        run: |
          wget https://github.com/launch4j/launch4j/releases/download/3.16/launch4j-3.16-linux.tar.gz
          tar xzf launch4j-3.16-linux.tar.gz
          LAUNCH4J_DIR=$(tar tzf launch4j-3.16-linux.tar.gz | head -1 | cut -f1 -d"/")
          echo "$PWD/$LAUNCH4J_DIR" >> $GITHUB_PATH

      - name: Generate Windows .exe
        run: launch4j launch4j-config.xml

      - name: Commit Builds to release branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin
          git checkout -B release
          git add dist/*.exe
          git commit -m "Update Windows build (.exe) [skip ci]" || echo "No changes to commit"
          git push --force origin release