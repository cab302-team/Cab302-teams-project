name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: maven

      #  Ensures that the JAR mockito-core-${mockito.version}.jar exists in ${settings.localRepository} (usually ~/.m2/repository) when the surefire plugin starts.
      - name: Resolve Maven dependencies
        run: mvn dependency:resolve

      - name: Build and run tests
        run: mvn clean verify

      #  for debugging check compiled test classes
      # - name: List target contents
      #  run: ls -R target || echo "No target directory found"
      # - name: List test reports
      #  run: ls -l target/surefire-reports/

#      - name: Report
#        if: always()
#        uses: dorny/test-reporter@v1
#        with:
#          name: Maven Tests
#          path: "target/surefire-reports/*.xml"
#          reporter: java-junit
#          fail-on-error: true
#
#      - name: Generate Javadoc
#        run: mvn javadoc:javadoc
#      - name: Publish Javadoc
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          folder: target/docs/javadoc
#          clean: true
#          target-folder: javadoc
#
#      - name: Publish Coverage Report
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          folder: target/site/jacoco
#          clean: false
#          target-folder: coverage
#
#      # Convert the HTML reports into PDFs
#      - name: Install wkhtmltopdf and pdfunite
#        run: |
#          sudo apt-get update
#          sudo apt-get install -y wkhtmltopdf
#          sudo apt-get install -y poppler-utils
#
#      - name: Create output directories
#        run: |
#          mkdir -p individual-pdfs
#          mkdir -p pdfs
#
#      - name: Generate PDFs from all JaCoCo HTML files
#        run: |
#          i=0
#          for file in $(find target/site/jacoco -name '*.html' | sort); do
#            wkhtmltopdf --enable-local-file-access "$file" individual-pdfs/jacoco-$i.pdf
#            i=$((i+1))
#          done
#
#      - name: Merge JaCoCo PDFs into one
#        run: |
#          pdfunite individual-pdfs/jacoco-*.pdf pdfs/test-coverage.pdf
#
#      - name: Generate PDFs from all Javadoc HTML files
#        run: |
#          i=0
#          for file in $(find target/docs/javadoc -name '*.html' | sort); do
#            wkhtmltopdf --enable-local-file-access "$file" individual-pdfs/javadoc-$i.pdf
#            i=$((i+1))
#          done
#
#      - name: Merge Javadoc PDFs into one
#        run: |
#          pdfunite individual-pdfs/javadoc-*.pdf pdfs/javadoc.pdf
#
#      - name: Commit PDFs to documentation branch
#        run: |
#          git config user.name "github-actions[bot]"
#          git config user.email "github-actions[bot]@users.noreply.github.com"
#          git checkout -B documentation
#          git add pdfs/*.pdf
#          git commit -m "Update documentation and test coverage PDFs [skip ci]"
#          git push --force origin documentation
#
#      - name: Publish PDFs to GitHub Pages
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          folder: pdfs
#          clean: false
#          target-folder: pdfs

      - name: Package application JAR
        run: mvn clean package -DskipTests

      - name: Install Launch4j via SDKMAN
        run: |
          curl -s "https://get.sdkman.io" | bash
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install launch4j 3.16.0

      - name: Generate Windows .exe with Launch4j
        run: |
          mkdir -p dist
          launch4j \
          --dont-wrapjar=false \
          --header-type=gui \
          --outfile dist/MyApp.exe \
          --jar target/Project-*.jar \
          --chdir . \
          --err-title "MyApp Error" \
          --support-url "https://github.com/${{ github.repository }}" \
          --jre-min-version 17

      - name: Commit Builds to release branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin
          git checkout -B release
          mkdir -p dist
          cp dist/*.exe .
          git add *.exe
          git commit -m "Update Windows build (.exe) [skip ci]" || echo "No changes to commit"
          git push --force origin release