<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsersDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Project</a> &gt; <a href="index.source.html" class="el_package">com.example.project.services.sqlite.dAOs</a> &gt; <span class="el_source">UsersDAO.java</span></div><h1>UsersDAO.java</h1><pre class="source lang-java linenums">package com.example.project.services.sqlite.dAOs;

import com.example.project.services.Logger;
import com.example.project.services.PasswordHasher;
import com.example.project.models.User;
import com.example.project.services.sqlite.SQLiteUsersConnection;

import java.sql.*;

/**
 * SQLite Users database. with a table `users` 2 columns. 'username', 'password'. Which are both defined as unique
 * not null Strings in sqlite.
 */
public class UsersDAO
{
    private final Logger logger;
    private final Connection connection;
<span class="fc" id="L18">    PasswordHasher passwordHasher = new PasswordHasher();</span>

    /**
     * Constructor for this class SQLLiteDictionary.
     */
    public UsersDAO()
<span class="fc" id="L24">    {</span>
<span class="fc" id="L25">        this.logger = new Logger();</span>
<span class="fc" id="L26">        this.connection = new SQLiteUsersConnection().getInstance();</span>
<span class="fc" id="L27">    }</span>

    protected UsersDAO(PasswordHasher hasher, Connection connection, Logger logger)
    {
<span class="fc" id="L31">        this(connection, logger);</span>
<span class="fc" id="L32">        this.passwordHasher = hasher;</span>
<span class="fc" id="L33">    }</span>

    /**
     * Constructor with injection for unit tests.
     * @param connection Connection
     * @param logger logger.
     */
    public UsersDAO(Connection connection, Logger logger)
<span class="fc" id="L41">    {</span>
<span class="fc" id="L42">        this.logger = logger;</span>
<span class="fc" id="L43">        this.connection = connection;</span>
<span class="fc" id="L44">    }</span>

    /**
     * Adds user to the user.db.
     * password will be hashed before storing to ensure greater security (no plain text passwords)
     * @param user user to add.
     */
    public void addUser(User user)
    {
<span class="fc" id="L53">        String sql = &quot;INSERT INTO users (username, password, highscore) VALUES (?, ?, ?)&quot;;</span>

        try
        {
<span class="fc" id="L57">            PreparedStatement query = this.connection.prepareStatement(sql);</span>
<span class="fc" id="L58">            query.setString(1, user.getUsername());</span>

<span class="fc" id="L60">            query.setString(2, this.passwordHasher.hashPassword(user.getPassword())); //hashes password before storing</span>

<span class="fc" id="L62">            query.setInt(3, user.getHighscore());</span>
<span class="fc" id="L63">            query.executeUpdate();</span>
<span class="fc" id="L64">            this.logger.logMessage(String.format(&quot;added user: %s to the database&quot;, user.getUsername()));</span>
        }
<span class="fc" id="L66">        catch (SQLException e)</span>
        {
<span class="fc" id="L68">            this.logger.logError(String.format(&quot;Failed to add user: %s to the database&quot;, user.getUsername()));</span>
<span class="fc" id="L69">            throw new RuntimeException(String.format(&quot;Failed to add user to the database. SQL Error details: %s&quot;, e.getMessage()));</span>
<span class="fc" id="L70">        }</span>
<span class="fc" id="L71">    }</span>

    /**
     * @param username username
     * @return returns bool indicating whether use is in database already.
     */
    public boolean doesUserExist(String username)
    {
<span class="fc bfc" id="L79" title="All 2 branches covered.">        return queryByUsername(username) != null;</span>
    }

    private User queryByUsername(String username)
    {
<span class="fc" id="L84">        String sql = &quot;SELECT username, password, highscore FROM users WHERE username = ?&quot;;</span>
        try
        {
<span class="fc" id="L87">            PreparedStatement statement = connection.prepareStatement(sql);</span>
<span class="fc" id="L88">            statement.setString(1, username);</span>
<span class="fc" id="L89">            ResultSet result = statement.executeQuery();</span>

<span class="fc bfc" id="L91" title="All 2 branches covered.">            if (!result.next()){ // if user does not exist in database return null.</span>
<span class="fc" id="L92">                return null;</span>
            }

<span class="fc" id="L95">            int highscore = result.getInt(&quot;highscore&quot;);</span>
<span class="fc" id="L96">            String usersPassword = result.getString(&quot;password&quot;);</span>
<span class="fc" id="L97">            return new User(username, usersPassword, highscore);</span>
        }
<span class="fc" id="L99">        catch (SQLException e)</span>
        {
<span class="fc" id="L101">            this.logger.logError(String.format(&quot;SQL Exception. Failed to get user username: %s&quot;, username));</span>
<span class="fc" id="L102">            this.logger.logError(String.format(&quot;%s&quot;, e.getMessage()));</span>
<span class="fc" id="L103">            throw new RuntimeException(&quot;Failed to get user by username&quot;, e);</span>
        }
    }

    /**
     * @param username username.
     * @return returns user with matching username.
     */
    public User getUser(String username)
    {
<span class="fc" id="L113">        return queryByUsername(username);</span>
    }

    /**
     * Saves the session data as JSON for a specific user.
     * @param username the username to save data for
     * @param sessionJson the JSON string containing session data
     */
    public void saveSessionData(String username, String sessionJson)
    {
<span class="fc" id="L123">        String sql = &quot;UPDATE users SET session_data = ? WHERE username = ?&quot;;</span>

        try {
<span class="fc" id="L126">            PreparedStatement statement = connection.prepareStatement(sql);</span>
<span class="fc" id="L127">            statement.setString(1, sessionJson);</span>
<span class="fc" id="L128">            statement.setString(2, username);</span>

<span class="fc" id="L130">            int rowsAffected = statement.executeUpdate();</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">            if (rowsAffected &gt; 0) {</span>
<span class="fc" id="L132">                logger.logMessage(String.format(&quot;Saved session data for user: %s&quot;, username));</span>
            } else {
<span class="fc" id="L134">                logger.logError(String.format(&quot;No user found with username: %s&quot;, username));</span>
            }
<span class="fc" id="L136">        } catch (SQLException e) {</span>
<span class="fc" id="L137">            logger.logError(String.format(&quot;Failed to save session data for user: %s&quot;, username));</span>
<span class="fc" id="L138">            logger.logError(String.format(&quot;SQL Error: %s&quot;, e.getMessage()));</span>
<span class="fc" id="L139">            throw new RuntimeException(&quot;Failed to save session data&quot;, e);</span>
<span class="fc" id="L140">        }</span>
<span class="fc" id="L141">    }</span>

    /**
     * Get session saved data.
     * @param username user.
     * @return returns string.
     */
    public String getSessionDataJson(String username) {
<span class="fc" id="L149">        String sql = &quot;SELECT session_data FROM users WHERE username = ?&quot;;</span>

        try {
<span class="fc" id="L152">            PreparedStatement statement = connection.prepareStatement(sql);</span>
<span class="fc" id="L153">            statement.setString(1, username);</span>
<span class="fc" id="L154">            ResultSet result = statement.executeQuery();</span>

<span class="fc bfc" id="L156" title="All 2 branches covered.">            if (result.next()) {</span>
<span class="fc" id="L157">                String sessionData = result.getString(&quot;session_data&quot;);</span>
<span class="fc" id="L158">                logger.logMessage(String.format(&quot;Loaded session data for user: %s&quot;, username));</span>
<span class="fc" id="L159">                return sessionData;</span>
            } else {
<span class="fc" id="L161">                logger.logMessage(String.format(&quot;No session data found for user: %s&quot;, username));</span>
<span class="fc" id="L162">                return null;</span>
            }

<span class="fc" id="L165">        } catch (SQLException e) {</span>
<span class="fc" id="L166">            logger.logError(String.format(&quot;Failed to load session data for user: %s&quot;, username));</span>
<span class="fc" id="L167">            logger.logError(String.format(&quot;SQL Error: %s&quot;, e.getMessage()));</span>
<span class="fc" id="L168">            throw new RuntimeException(&quot;Failed to load session data&quot;, e);</span>
        }
    }

    /**
     * Does user have save data.
     * @param user user.
     * @return returns true if save data exists.
     */
    public boolean hasSaveData(User user)
    {
<span class="fc" id="L179">        String sql = &quot;SELECT session_data FROM users WHERE username = ?&quot;;</span>

        try {
<span class="fc" id="L182">            PreparedStatement statement = connection.prepareStatement(sql);</span>
<span class="fc" id="L183">            statement.setString(1, user.getUsername());</span>
<span class="fc" id="L184">            ResultSet result = statement.executeQuery();</span>

<span class="fc bfc" id="L186" title="All 2 branches covered.">            if (result.next()) {</span>
<span class="fc" id="L187">                String sessionData = result.getString(&quot;session_data&quot;);</span>
                // Check if session_data is not null and not empty
<span class="fc bfc" id="L189" title="All 4 branches covered.">                boolean hasSave = sessionData != null &amp;&amp; !sessionData.trim().isEmpty();</span>
<span class="fc" id="L190">                logger.logMessage(String.format(&quot;User %s %s save data&quot;,</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">                        user.getUsername(), hasSave ? &quot;has&quot; : &quot;does not have&quot;));</span>
<span class="fc" id="L192">                return hasSave;</span>
            } else {
<span class="fc" id="L194">                logger.logError(String.format(&quot;User not found: %s&quot;, user.getUsername()));</span>
<span class="fc" id="L195">                return false;</span>
            }

<span class="fc" id="L198">        } catch (SQLException e) {</span>
<span class="fc" id="L199">            logger.logError(String.format(&quot;Failed to check save data for user: %s&quot;, user.getUsername()));</span>
<span class="fc" id="L200">            logger.logError(String.format(&quot;SQL Error: %s&quot;, e.getMessage()));</span>
<span class="fc" id="L201">            return false; // Return false instead of throwing to handle missing column gracefully</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>